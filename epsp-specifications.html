<!DOCTYPE html>
<HTML lang="ja">
<HEAD>
<META charset="utf-8">
<TITLE>Earthquake Peer-to-peer Sharing Protocol (EPSP) 0.33 プロトコル仕様</TITLE>
<STYLE type="text/css">
<!--
BODY{
  margin-top : 5%;margin-right : 5%;margin-bottom :5%;margin-left : 5%;
  line-height : 125%;
}
H2{
  border-left-width : 5px;
  border-bottom-width : 3px;
  border-left-style : solid;
  border-bottom-style : solid;
  border-left-color : #016ba5;
  border-bottom-color : #016ba5;
  padding-left : 2px;
  padding-bottom : 2px;
}
H3{
  border-left-width : 4px;
  border-bottom-width : 2px;
  border-left-style : solid;
  border-bottom-style : solid;
  border-left-color : #016ba5;
  border-bottom-color : #016ba5;
  padding-left : 2px;
  padding-bottom : 2px;
}
H4{
  border-left-width : 3px;
  border-bottom-width : 1px;
  border-left-style : solid;
  border-bottom-style : solid;
  border-left-color : #016ba5;
  border-bottom-color : #016ba5;
  padding-left : 2px;
  padding-bottom : 2px;
}
DD{
  
  margin-left : 15px;
  
  
  margin-bottom : 10px;
}
IMG{border-width : 2px 2px 2px 2px;border-style : solid solid solid solid;
  margin-top : 0.2em;
  margin-left : 0.2em;
  margin-right : 0.2em;
  margin-bottom : 0.2em;
}
.sample{border-width : 1px 1px 1px 1px;border-style : solid solid solid solid;
  margin-left : 10px;
}

-->
</STYLE>

</HEAD>
<BODY>
<H2>Earthquake Peer-to-peer Sharing Protocol (EPSP) 0.33
プロトコル仕様</H2>
<H3><A name="top">目次</A></H3>
<DL>
  <DT><A href="#base"><B>基本概要</B></A>
  <DD><A href="#base-1">1.バージョン</A><BR>
  <A href="#base-2">2.基本仕様</A> (Ver0.28 一部変更)<BR>
  <A href="#base-3">3.公開鍵暗号への対応</A><BR>
  <A href="#base-4">4.「プロトコル時刻」</A> (Ver0.30r 一部変更)<BR>
  <A href="#base-5">5.「3桁の数字（コード）」一覧表</A> (Ver0.24,0.26,0.28,0.29 一部変更、0.30 一部追加・変更・廃止)<BR>
  <A href="#base-6">6.「地域コード」</A> (Ver0.30r 変更)
  <DT><B><A href="#networkjoin">P2Pネットワークへの参加</A></B>
  <DD><A href="#networkjoin-1">1.サーバーへの接続</A> (Ver0.33 一部変更)<BR>
  <A href="#networkjoin-2">2.プロトコルバージョン等の通知</A><BR>
  <A href="#networkjoin-3">3.ピアIDの暫定割り当て・ポート開放のチェック</A><BR>
  <A href="#networkjoin-4">4.ピアデータの取得・ピアとの接続</A> (Ver0.30 一部追加・変更)<BR>
  <A href="#networkjoin-5">5.ピアIDの本割り当て・鍵の取得</A> (Ver0.29 一部変更)<BR>
  <A href="#networkjoin-6">6.各地域ピア数の取得</A> (Ver0.21 新規)<BR>
  <A href="#networkjoin-7">7.プロトコル時刻の取得</A><BR>
  <A href="#networkjoin-8">8.サーバーとの接続終了</A>
  <DT><A href="#echokey"><B>サーバーへの定期エコー</B></A>
  <DD><A href="#echokey-1">1.サーバーへの接続</A><BR>
  <A href="#echokey-2">2.プロトコルバージョン等の通知</A><BR>
  <A href="#echokey-3">3.エコー</A> (Ver0.26 一部変更)<BR>
  <A href="#echokey-4">4.鍵の再割り当て要求</A><BR>
  <A href="#echokey-5">5.ピアとの接続数増加</A> (Ver0.30 変更)<BR>
  <A href="#echokey-6">6.プロトコル時刻の再取得</A> (Ver0.28 新規)<BR>
  <A href="#echokey-7">7.サーバーとの接続終了</A>
  <DT><A href="#networkquit"><B>P2Pネットワークへの参加終了</B></A>
  <DD><A href="#networkquit-1">1.ピアとの接続終了</A><BR>
  <A href="#networkquit-2">2.サーバーへの接続</A><BR>
  <A href="#networkquit-3">3.プロトコルバージョン等の通知</A><BR>
  <A href="#networkquit-4">4.参加終了</A><BR>
  <A href="#networkquit-5">5.サーバーとの接続終了</A>
  <DT><A href="#peersys"><B>ピアとのシステム通信</B></A>
  <DD><A href="#peersys-1">1.接続の受け付け</A><BR>
  <A href="#peersys-2">2.接続時の初期通信</A> (Ver0.30 名称変更、一部追加)<BR>
  <A href="#peersys-3">3.ピア同士のエコー</A><BR>
  <A href="#peersys-4">4.ピアネットワークの調査</A> (Ver0.28 新規)
  <DT><A href="#peerdata"><B>ピアとのデータ通信</B></A>
  <DD><A href="#peerdata-1">1.重複判定・各ピアへの伝達</A><BR>
  <A href="#peerdata-2">2.署名</A> (Ver0.27r 表記変更)<BR>
  <A href="#peerdata-3">3.地震情報</A> (Ver0.23,0.25,0.27 一部変更)<BR>
  <A href="#peerdata-4">4.津波予報</A><BR>
  <A href="#peerdata-5">5.各地域ピア数</A><BR>
  <A href="#peerdata-6">6.ユーザー署名の扱い - 署名</A> (Ver0.27r,0.30,0.30r2 一部変更)<BR>
  <A href="#peerdata-7">7.ユーザー署名の扱い - 検証</A> (Ver0.27r,0.30 一部変更)<BR>
  <A href="#peerdata-8">8.「多重発信」の識別</A><BR>
  <A href="#peerdata-9">9.地震感知情報</A> (Ver0.30 変更)<BR>
  <A href="#peerdata-10">10.伝言板</A> (Ver0.30 変更、0.33 廃止)
</DL>
<H3><A name="base">基本概要</A></H3>
<P>　当プロトコルは、地震情報・津波予報・地震感知情報メッセージの3つを、P2Pネットワークで速やかに伝達・共有することを目的としたものです。Ver0.20より、地震情報の署名・発信元ピアの保証を追加し、安全性が格段に向上しました。</P>
<P align="right"><A href="#top">目次へ</A></P>
<H4><A name="base-1">1.バージョン</A></H4>
<DL>
  <DT><B>Ver0.33</B>(2018/02/18改定)
  <DD>・伝言板(コード556)を廃止しました。<BR>・サーバー情報を更新しました。
  <DT><B>Ver0.30r2</B>(2006/04/16改定)
  <DD>・プロトコル時刻で許容される誤差を、60秒未満から1秒未満に変更しました。<BR>・ユーザー署名における有効期限の設定を、3分から1分に変更しました。
  <DT><B>Ver0.30r</B>(2006/03/14改定)
  <DD>・地域コード区分を変更しました（<A href="#base-6">6.地域コード</A>）。
  <DT><B>Ver0.30</B>(2006/03/12改定、<B><FONT color="#ff0000">互換性なし</FONT></B>)
  <DD><FONT color="#ff0000">感知情報・伝言板フォーマットと、ピアデータのフォーマットを変更したため、過去バージョンとの互換性がありません。</FONT><BR>
  ・Ver0.30以降、変更点の前後に<B><FONT color="Navy">紺太字</FONT></B>でバージョン番号を付記します。<BR>
  ・ピアデータ取得について、ネットワーク参加時・エコー時で同じコード(115/235)を使用するようにしました。<BR>
  ・ピアデータにピアのIDを追加しました。<BR>
  ・ピアデータ取得後に、接続したピアのIDを通知するコード155を追加しました。<BR>
  （→<A href="#networkjoin">P2Pネットワークへの参加</A> - <A href="#networkjoin-4">4.ピアデータの取得・ピアとの接続</A> 及び <A href="#echokey">サーバーへの定期エコー</A> - <A href="#echokey-5">5.ピアとの接続数増加</A>）<BR>
  ・ピアとの接続時、ピア間で対応プロトコルバージョンの通知・拒否を行うようにしました（<A href="#peersys">ピアとのシステム通信</A> - <A href="#peersys-2">2.接続時の初期通信</A>）。<BR>
  ・感知情報・伝言板のフォーマットを、拡張性のある形に変更しました。<BR>
  ・伝言板データに、地域コード、ID・ID署名を追加しました。<BR>
  （→<A href="#peerdata">ピアとのデータ通信</A> - <A href="#peerdata-6">6.ユーザー署名の扱い - 署名</A>/<A href="#peerdata-7">7.ユーザー署名の扱い - 検証</A>/<A href="#peerdata-9">9.地震感知情報</A>/<A href="#peerdata-10">10.伝言板</A>）
  <DT><B>Ver0.29</B>(2006/03/06改定)
  <DD>・受け入れ可能なピア数を通知するようにしました（<A href="#networkjoin">P2Pネットワークへの参加</A> - <A href="#networkjoin-5">5.ピアIDの本割り当て・鍵の取得</A>）。
  <DT><B>Ver0.28</B>(2006/02/27改定)
  <DD>・プロトコル仕様への準拠の厳格さについてを追記しました（<A href="#base-2">2.基本仕様</A>）。<BR>
  ・ピアネットワークの調査に関してを追加しました（<A href="#peersys">ピアとのシステム通信</A> - <A href="#peersys-4">4.ピアネットワークの調査</A>）。対応は必須です（※データのスルーだけで可）。<BR>
  ・サーバーへのエコー時、プロトコル時刻を再取得出来ます（<A href="#echokey">サーバーへの定期エコー</A> - <A href="#echokey-6">6.プロトコル時刻の再取得</A>）。ソフトウェア起動中におけるコンピュータ時刻の変更などに対応します。対応は必須ではありません。
  <DT><B>Ver0.27r</B>(2006/01/21改定、サーバー側変更点無し)
  <DD><S><FONT color="Gray">・「<A href="#peerdata">ピアとのデータ通信</A> - <A href="#peerdata-7">7.ユーザー署名の扱い - 検証</A>」に、オフィシャルP2PQ_Clientにおける準拠ミスについて追記しました。当面の間、準拠ミスの署名についても対応することを推奨します。</FONT></S><FONT color="Navy"><B>(Ver0.30リリースにより、この対応は不要となりました)</B></FONT><BR>
  ・同「<A href="#peerdata-6">6.ユーザー署名の扱い - 署名</A>」で定められているユーザーデータの有効期限について、「3〜4分程度」から「3分」に変更しました。<BR>
  ・上記2項目と、同「<A href="#peerdata-2">2.署名</A>」において、説明不足と思われる点などを追記・変更しました。
  <DT><B>Ver0.27</B>(2005/11/15改定)
  <DD>・地震情報に「発表管区」を追加しました（<A href="#peerdata">ピアとのデータ通信</A> - <A href="#peerdata-3">3.地震情報</A>）。対応は必須ではありませんが、実装によってはプログラムの修正が必要となります。
  <DT><B>Ver0.26</B>（2005/10/30改定）
  <DD>・サーバーへのエコー時、ピア接続数を報告するようにしました（<A href="#echokey">サーバーへの定期エコー</A> - <A href="#echokey-3">3.エコー</A>）。EPSPネットワークの正常な構築を行うため、対応することを強く推奨します。
  <DT><B>Ver0.25</B>（2005/10/09改定）
  <DD>・新たに「緯度」「経度」を追加しました（<A href="#peerdata">ピアとのデータ通信</A> - <A href="#peerdata-3">3.地震情報</A>）。対応は必須ではありませんが、実装によってはプログラムの修正が必要となります。
  <DT><B>Ver0.24</B>（2005/10/01改定）
  <DD>・コード298を追加しました（<A href="#base-5">「3桁の数字（コード）」一覧表</A>）。これは、プロトコル仕様に準拠しない不正なプログラムを拒否するためのものです。
  <DT><B>Ver0.23</B>（2005/07/23改定）
  <DD>・「震度訂正」フラグを付加しました。対応は必須ではありませんが、実装によってはプログラムの修正が必要となる場合があります。
  <DT><B>Ver0.22</B>（2005/07/03改定）
  <DD>・サーバーの分散化に対応し、「<A href="#networkjoin">P2Pネットワークへの参加</A>」の「<A href="#networkjoin-1">1.サーバーへの接続</A>」を大幅修正しました。安定性向上のため対応することを強く推奨します。<BR>
  ・プロトコル上対応が必須でないものについて、その点を追記しました。（追記箇所：基本仕様-<A href="#base-3">3.公開鍵暗号への対応</A>、P2Pネットワークへの参加-<A href="#networkjoin-1">1.サーバーへの接続</A>[分散化]）。
  <DT><B>Ver0.21</B>（2005/05/05改定）
  <DD>・「<A href="#networkjoin">P2Pネットワークへの参加</A>」に、「<A href="#networkjoin-6">6.各地域ピア数の取得</A>」を追加しました。参加した時点で各地域ピア数を把握することが可能となっています。この機能への対応は必須ではありません。
  <DT><B>Ver0.20</B>（2005/03/14、03/20、03/24、04/16ほか改定）
  <DD>・全面的な見直しを行いました。<BR>
  　→コードの3桁化<BR>
  　→ステップの厳格化<BR>
  　→地震情報・津波予報における署名、地震感知情報・伝言板におけるユーザー署名<BR>　→伝言板における「:（半角コロン）」「&amp;（半角アンパサンド）」「改行」取り扱いの定義
  <DT><B>Ver0.13</B>（2005/01/27改定）
  <DD>コード11（ピア情報要求）の仕様が変更されました。<BR>コード22（エラーメッセージ）を追加しました。
  <DT><B>Ver0.12</B>（2005/01/20改定）
  <DD>コード86（ピアエコー）を追加しました。
  <DT><B>Ver0.11</B>（2005/01/10）
  <DD>コード15（ピア参加通知）の仕様が変更されました。「他ピアから接続を受け付けるかどうか」の指定が可能となっています（ネットワークへの参加→3.サーバーへの参加通知
  に追記）。<BR>「サーバーへのエコー」にエコー間隔（頻度）についてを追加しました。
  <DT><B>Ver0.10</B>（2004/12/16）
  <DD>プロトコル仕様を公開しました。
</DL>
<P align="right"><A href="#top">目次へ</A></P>
<H4><A name="base-2">2.基本仕様</A> (Ver0.28 一部変更)</H4>
<P>　TCP/IPを使用します。「サーバー」との通信は6910ポート、「ピア」との通信は6911〜6915ポート等（特に制限はない）を使用します。</P>
<P>　通信は、すべて「3桁の数字（コード） ＋
半角スペース ＋ 経由数 ＋ 半角スペース ＋
データ ＋ 改行(CRLF)」の形で行われます。データはShift-JISエンコードで、複数ある場合は原則として「:（半角コロン）」で区切ります。</P>
<P>　「経由数」は、発信元からデータを受信するまでに経由したピアの数です。サーバーとの通信では常に「1」です。ピアとの通信では、データを他のピアへ伝達する際に1増やさなくてはいけません。また、無限ループを防ぐため、経由数が総参加ピア数を超える場合、データをそれ以上他のピアに伝達してはいけません。</P>
<P>　<B>(Ver0.28 重要追記)</B><BR>
　また、Ver0.24から、コード298(プロトコル仕様への非準拠エラー)が追加されました。このプロトコル仕様とは少しでも異なる手順を取ると、サーバーからコード298が返され、それ以降の処理を一切行わないようになっています。</P>
<P class="sample"><B>[サーバーとの通信データ例]</B><BR>
↑ 116 1 25:6911:901:2<BR>
↓ 236</P>
<P class="sample"><B>[ピア同士の通信データ例]</B><BR>
↓ 551 12 ABCDEFG:23時56分,3,0,1,4,東海道沖,10km,3.2,1:-奈良県,+震度1,下北山村<BR>
↑（他ピアに） 551 13 ABCDEFG:23時56分,3,0,1,4,東海道沖,10km,3.2,1:-奈良県,+震度1,下北山村</P>
<P align="right"><A href="#top">目次へ</A></P>
<H4><A name="base-3">3.公開鍵暗号への対応</A></H4>
<P>　注：<U>公開鍵暗号への対応は必須ではありません</U>。ただし、対応しない場合「データの正当性を検証できない」「地震感知情報メッセージを発信できない」という制限があります。</P>
<P>　当プロトコルでは、地震情報・津波予報の偽装防止、地震感知情報メッセージの連続発信の制限を目的として、公開鍵暗号を使用しています。</P>
<DL>
  <DT><B>地震情報・津波予報</B>（署名）
  <DD>PKCS #1 v1.5に準拠したRSASSA(1024bit)を使用しています。ハッシュアルゴリズムはSHA-1です。<BR>（※出来ればECDSA）
  <DT><B>地震感知情報</B>（署名）
  <DD>PKCS #1 v1.5に準拠したRSASSA(384bit)を使用しています。ハッシュアルゴリズムはSHA-1です。鍵は、有効期限付きでサーバーから各ピアに発行されるため、384bitの強度でも（現在のところ）安全です。</DL>
<P>　あくまで「署名」目的によるもので、データそのものが暗号化されるわけではありません。</P>
<P align="right"><A href="#top">目次へ</A></P>
<H4><A name="base-4">4.「プロトコル時刻」 (Ver0.30r 一部変更)</A></H4>
<P>　当プロトコルでは、鍵やデータの有効期限は、すべて「プロトコル時刻」を基準にしています。コンピュータの時計のズレ、あるいは時差の影響を受けることのないようにするためです。「プロトコル時刻」において許容される時刻誤差は、プラスマイナス1秒未満です。</P>
<P>　プロトコル時刻は、P2Pネットワークへの参加時にサーバーから供給されます。「コンピュータの時計」と「プロトコル時刻」との差がプラスマイナス1秒未満であれば、コンピュータの時計をそのままプロトコル時刻として使っても構いません。</P>
<P>　差がプラスマイナス1秒以上であれば、コンピュータの時計とプロトコル時刻との差を記憶しておくといった方法で、必要な時に「プロトコル時刻」を算出する必要があります。</P>
<P align="right"><A href="#top">目次へ</A></P>
<H4><A name="base-5">5.「3桁の数字（コード）」一覧表 (Ver0.24,0.26,0.28,0.29
一部変更、Ver0.30 一部追加・変更・廃止)</A></H4>
<P>　「x1x」「x2x」は「要求」、「x3x」「x4x」は「返答」、「x5x」「x6x」は「伝達・発信」、「x9x」は「エラー」となっています。</P>
<P>　注意：下記で「データ：不要」「データ：なし」と記されているのは、プロトコルにおける「データ」部分で何も指定（解析）する必要がないという意味です。逆に言えば、データに何を指定しても構いません。</P>
<TABLE border="1" width="95%" cellspacing="0">
  <TBODY>
    <TR>
      <TD colspan="2"><B>ピアからサーバーへ</B>(100番台)</TD>
    </TR>
    <TR>
      <TD><FONT color="#999999"><B>112</B></FONT></TD>
      <TD><FONT color="#999999">（※通信ステップの簡略化により使用していません）<BR>
      サーバーの対応プロトコルバージョン、ソフトウェア名・ソフトウェアバージョンを要求します。<BR>
      　データ：不要</FONT></TD>
    </TR>
    <TR>
      <TD nowrap><B>113</B></TD>
      <TD>ピアIDの暫定割り当てを要求します。<BR>
      　データ：不要</TD>
    </TR>
    <TR>
      <TD><B>114</B></TD>
      <TD>ポート開放のチェックを要求します。<BR>
      　データ：ピアID、ポート番号</TD>
    </TR>
    <TR>
      <TD><B>115</B></TD>
      <TD>参加中のピアデータを要求します。<BR>
      　データ：ピアID</TD>
    </TR>
    <TR>
      <TD><B>116</B></TD>
      <TD>ピアIDの本割り当てを要求します。<BR>
      　データ：ピアID、ポート番号、地域コード、接続数、最大接続数</TD>
    </TR>
    <TR>
      <TD><B>117</B></TD>
      <TD>鍵の割り当てを要求します。<BR>
      　データ：ピアID</TD>
    </TR>
    <TR>
      <TD><B>118</B></TD>
      <TD>基準となるプロトコル時刻を要求します。<BR>
      　データ：なし</TD>
    </TR>
    <TR>
      <TD><B>119</B></TD>
      <TD>通信の終了を要求します。<BR>
      　データ：不要</TD>
    </TR>
    <TR>
      <TD><B>123</B></TD>
      <TD>エコー日時更新を要求します。<BR>
      　データ：ピアID、接続数</TD>
    </TR>
    <TR>
      <TD><B>124</B></TD>
      <TD>鍵の再割り当てを要求します。<BR>
      　データ：ピアID、以前割り当てた秘密鍵</TD>
    </TR>
    <TR>
      <TD><FONT color="Gray"><B>126</B></FONT></TD>
      <TD><FONT color="Navy"><B>Ver0.30 廃止(115に統合)</B></FONT><FONT color="Gray">参加中のピアデータを要求します（接続維持用）。<BR>
      　データ：ピアID</FONT></TD>
    </TR>
    <TR>
      <TD><B>127</B></TD>
      <TD>(Ver0.21新規)各地域ピア数を要求します。<BR>
      　データ：なし</TD>
    </TR>
    <TR>
      <TD><B>128</B></TD>
      <TD>参加終了を要求します。<BR>
      　データ：ピアID、以前割り当てた秘密鍵</TD>
    </TR>
    <TR>
      <TD></TD>
      <TD></TD>
    </TR>
    <TR>
      <TD><B>131</B></TD>
      <TD>([211]に対し)対応プロトコルバージョン、ソフトウェア名・ソフトウェアバージョンを返します。<BR>
      　データ：プロトコルバージョン、ソフトウェア名、バージョン</TD>
    </TR>
    <TR>
      <TD></TD>
      <TD></TD>
    </TR>
    <TR>
      <TD><B>１55</B></TD>
      <TD><B><FONT color="Navy">Ver0.30 追加</FONT></B><BR>
      ([235]受信後)新たに接続出来たピアのIDを通知します。<BR>
      　データ：ピアID</TD>
    </TR>
    <TR>
      <TD></TD>
      <TD></TD>
    </TR>
    <TR>
      <TD><B>192</B></TD>
      <TD>サーバーの対応プロトコルバージョンが古く、互換性がありません。<BR>
      　データ：不要</TD>
    </TR>
    <TR>
      <TD colspan="2"><B>サーバーからピアへ</B>(200番台)</TD>
    </TR>
    <TR>
      <TD><B>211</B></TD>
      <TD>ピアの対応プロトコルバージョン、ソフトウェア名・ソフトウェアバージョンを要求します。<BR>
      　データ：なし</TD>
    </TR>
    <TR>
      <TD></TD>
      <TD></TD>
    </TR>
    <TR>
      <TD><B>232</B></TD>
      <TD><FONT color="#999999">（※本来は[112]に対するものですが、通信ステップの簡略化により変更しています）</FONT><BR>
      ([131]に対し)対応プロトコルバージョン、ソフトウェア名・ソフトウェアバージョンを返します。<BR>
      　データ：プロトコルバージョン、ソフトウェア名、バージョン</TD>
    </TR>
    <TR>
      <TD><B>233</B></TD>
      <TD>([113]に対し)ピアIDを暫定的に割り当てます。割り当てたピアIDを返します。<BR>
      　データ：割り当てたピアID</TD>
    </TR>
    <TR>
      <TD><B>234</B></TD>
      <TD>([114]に対し)ポート開放のチェック結果を返します。<BR>
      　データ：結果（成功：1、失敗：0）</TD>
    </TR>
    <TR>
      <TD><B>235</B></TD>
      <TD><FONT color="Navy"><B>Ver0.30 変更</B></FONT><BR>
      ([115]に対し)参加中のピアデータを返します。<BR>
      　データ：「IPアドレス,ポート,<FONT color="Navy">ピアID</FONT>:IPアドレス,ポート,<FONT color="Navy">ピアID</FONT>...」</TD>
    </TR>
    <TR>
      <TD><B>236</B></TD>
      <TD>([116]に対し)ピアIDの本割り当てを行います。<BR>
      　データ：現在の参加ピア総数</TD>
    </TR>
    <TR>
      <TD><B>237</B></TD>
      <TD>([117]に対し)鍵の割り当てを行います。<BR>
      　データ：秘密鍵、公開鍵、有効期限、鍵の署名</TD>
    </TR>
    <TR>
      <TD><B>238</B></TD>
      <TD>([118]に対し)基準となるプロトコル時刻を返します。<BR>
      　データ：プロトコル時刻</TD>
    </TR>
    <TR>
      <TD><B>239</B></TD>
      <TD>([119]に対し)通信の終了を受け入れます。<BR>
      　データ：なし</TD>
    </TR>
    <TR>
      <TD><B>243</B></TD>
      <TD>([123]に対し)エコー日時更新を受け入れます。<BR>
      　データ：なし</TD>
    </TR>
    <TR>
      <TD><B>244</B></TD>
      <TD>([124]に対し)鍵の再割り当てを行います。<BR>
      　データ：秘密鍵、公開鍵、有効期限、鍵の署名</TD>
    </TR>
    <TR>
      <TD><FONT color="Gray"><B>246</B></FONT></TD>
      <TD><FONT color="Navy"><B>Ver0.30 廃止(235に統合)</B></FONT><FONT color="Gray">([126]に対し)参加中のピアデータを返します（接続維持用）。<BR>
      　データ：「IPアドレス,ポート:IPアドレス,ポート...」</FONT></TD>
    </TR>
    <TR>
      <TD><B>247</B></TD>
      <TD>各地域のピア数を伝達します。<BR>
      　データ：地域コード,ピア数;地域コード,ピア数...</TD>
    </TR>
    <TR>
      <TD><B>248</B></TD>
      <TD>([128]に対し)参加終了を受け入れます。<BR>
      　データ：なし</TD>
    </TR>
    <TR>
      <TD></TD>
      <TD></TD>
    </TR>
    <TR>
      <TD><B>291</B></TD>
      <TD>原因不明のエラーが発生しました。<BR>
      　データ：なし　対処：処理を中止します。</TD>
    </TR>
    <TR>
      <TD><B>292</B></TD>
      <TD>([131]に対し)ピアの対応プロトコルバージョンが古く、互換性がありません。<BR>
      　データ：なし　対処：ユーザーにその旨を伝え、P2Pネットワークへの参加を中止します。</TD>
    </TR>
    <TR>
      <TD><B>293</B></TD>
      <TD>要求が正しくありません。<BR>
      　データ：なし　対処：処理を中止します。</TD>
    </TR>
    <TR>
      <TD><B>295</B></TD>
      <TD>([117][124]に対し)鍵は既に割り当て済みです。<BR>
      　データ：なし　対処：（鍵がない・期限が切れている場合）次回サーバーへのエコー時に再割り当てを要求します。</TD>
    </TR>
    <TR>
      <TD><B>298</B></TD>
      <TD>処理の流れがプロトコル仕様に準拠していません。<BR>
      　データ：なし　対処：プログラムがプロトコル仕様に準拠するよう修正します。</TD>
    </TR>
    <TR>
      <TD><B>299</B></TD>
      <TD>IPアドレスが違います。<BR>
      　データ：なし　対処：一旦ネットワークから切断し、参加しなおします。</TD>
    </TR>
    <TR>
      <TD colspan="2"><B>ピアからピアへ</B>(データ伝達は500番台、システム通信は600番台)</TD>
    </TR>
    <TR>
      <TD><B>551</B></TD>
      <TD>地震情報を伝達します。<BR>
      　データ：データ署名、有効期限、地震情報概要、地震情報詳細</TD>
    </TR>
    <TR>
      <TD><B>552</B></TD>
      <TD>津波予報を伝達します。<BR>
      　データ：データ署名、有効期限、津波予報詳細、津波予報全文</TD>
    </TR>
    <TR>
      <TD><B>555</B></TD>
      <TD>地震感知情報を伝達します。<BR>
      　データ：データ署名、有効期限、公開鍵、鍵署名、鍵期限、感知情報データ</TD>
    </TR>
    <TR>
      <TD><FONT color="Gray"><B>556</B></FONT></TD>
      <TD><FONT color="Navy"><B>Ver0.33 廃止</B></FONT><FONT color="Gray">伝言板を伝達します。<BR>
      　データ：データ署名、有効期限、公開鍵、鍵署名、鍵期限、伝言板データ</FONT></TD>
    </TR>
    <TR>
      <TD><B>561</B></TD>
      <TD>各地域のピア数を伝達します。<BR>
      　データ：データ署名、有効期限、「地域コード,ピア数;地域コード,ピア数...」</TD>
    </TR>
    <TR>
      <TD></TD>
      <TD></TD>
    </TR>
    <TR>
      <TD><B>611</B></TD>
      <TD>ピアエコーを要求します。<BR>
      　データ：不要</TD>
    </TR>
    <TR>
      <TD><B>612</B></TD>
      <TD>ピアIDを要求します。<BR>
      　データ：不要</TD>
    </TR>
    <TR>
      <TD><B>614</B></TD>
      <TD><B><FONT color="Navy">Ver0.30 追加</FONT></B><BR>
      ピア対応プロトコルバージョン、ソフトウェア名・ソフトウェアバージョンを要求します。<BR>
      　データ：プロトコルバージョン、ソフトウェア名、バージョン</TD>
    </TR>
    <TR>
      <TD><B>615</B></TD>
      <TD>調査エコーを要求します。<BR>
      　データ：発信者ピアID、一意な数値</TD>
    </TR>
    <TR>
      <TD></TD>
      <TD></TD>
    </TR>
    <TR>
      <TD><B>631</B></TD>
      <TD>([611]に対し)ピアエコーを返します。<BR>
      　データ：不要</TD>
    </TR>
    <TR>
      <TD><B>632</B></TD>
      <TD>([612]に対し)ピアIDを返します。<BR>
      　データ：ピアID</TD>
    </TR>
    <TR>
      <TD><B>634</B></TD>
      <TD><B><FONT color="Navy">Ver0.30 追加</FONT></B><BR>
      ([614]に対し)ピア対応プロトコルバージョン、ソフトウェア名・ソフトウェアバージョンを返します。<BR>
      　データ：プロトコルバージョン、ソフトウェア名、バージョン</TD>
    </TR>
    <TR>
      <TD><B>635</B></TD>
      <TD>([615]に対し)調査エコーを返します。<BR>
      　データ：発信者ピアID、一意な数値、自ピアID、接続中(隣接)ピアID、到達経路(hop)数</TD>
    </TR>
    <TR>
      <TD></TD>
      <TD></TD>
    </TR>
    <TR>
      <TD><B>694</B></TD>
      <TD><B><FONT color="Navy">Ver0.30 追加</FONT></B><BR>
      ([614][634]に対し)相手ピアの対応プロトコルバージョンが低く、互換性がありません。<BR>
      　データ：なし　対応：いくつかのピアから同様のエラーが返る場合、最新バージョンを確認します。</TD>
    </TR>
  </TBODY>
</TABLE>
<P align="right"><A href="#top">目次へ</A></P>
<H4><A name="base-6">6.「地域コード」</A> (Ver0.30r 変更)</H4>
<P>　「地域コード」は3ケタの数値で、「地震感知情報」の送受信や、「ピア分布」の作成に必要となるものです。地域の区切りに深い意味はありません。なお、今後変更される可能性がありますので、変更に対応しやすい実装を行うことを推奨します。</P>
<P>　<FONT color="navy"><B>(Ver0.30r重要)</B></FONT>Ver0.30rより、地域コード区分が変更されました。新しい地域区分は、震度速報で用いられる地域区分(計186)を、少しおおまかにしたものです(計138、未設定など含め計141)。</P>
<DL>
  <DT><B><A href="epsp-area.csv">epsp-area.csv</A> - 地域コード 定義ファイル</B>（2006/03/14）
  <DD>　「地域コード」「地域名」「都道府県名」「地方名」をカンマ区切り(CSV方式)で定義しています。「地域名」及び「都道府県名」は必須ではないため、実装で不要な場合は省いても構いません。
</DL>
<P align="right"><A href="#top">目次へ</A></P>
<H3><A name="networkjoin">P2Pネットワークへの参加</A></H3>
<P align="right"><A href="#top">目次へ</A></P>
<H4><A name="networkjoin-1">1.サーバーへの接続</A> (Ver0.33 一部変更)</H4>
<P>　注1：<U>分散化への対応は必須ではありません</U>。が、安定性や信頼性向上のために、対応することを強く推奨します。対応しない場合、接続先はwww.p2pquake.netとしてください。<BR>
　注2：Ver0.20時点で分散化しているとの表記を行っておりましたが、これは誤りです。<U>分散化はVer0.22より対応しています</U>。</P>
<P>　当プロトコルに準拠するサーバーは、全国各地で複数稼動しています。これは、大規模地震（または軽微なメンテナンス）等で一部のサーバーがダウンした場合や、地震発生時に集中するアクセスの分散などを想定したものです。</P>
<P>当プロトコルに準拠しているサーバーは、各地に分散しています。これは、万が一大規模な地震等が発生し一部のサーバーがダウンした場合においても、問題なくネットワークが稼動出来るようにするためです。また、アクセス分散にも効果があります。プロトコル仕様書リリースの時点で稼動しているサーバーは、次の通りです。</P>
<TABLE border="1" cellspacing="0">
  <TBODY>
    <TR>
      <TD><B>サーバーアドレス</B></TD>
      <TD><B>運営者名</B></TD>
      <TD><B>地方</B></TD>
    </TR>
    <TR>
      <TD>p2pquake.dyndns.info</TD>
      <TD>nanashisan氏</TD>
      <TD>北海道</TD>
    </TR>
    <TR>
      <TD>www.p2pquake.net</TD>
      <TD>たくや</TD>
      <TD rowspan="3">関東</TD>
    </TR>
    <TR>
      <TD>p2pquake.dnsalias.net</TD>
      <TD>saya氏</TD>
    </TR>
    <TR>
      <TD>p2pquake.ddo.jp</TD>
      <TD>たくや</TD>
    </TR>
  </TBODY>
</TABLE>
<P>　各サーバーは常にデータを同期しているため、アクセスを分散する意味でも接続するサーバーは毎回ランダムで決定してください。</P>
<P>　決定したら、サーバーへの接続を開始します（ポートは6910）。タイムアウト等で接続出来なかった場合は、再びサーバーを選びなおして作業を繰り返してください。なお、タイムアウトまでの時間は2〜3秒と短くても構いません。</P>
<P>　注意：同一IPアドレスから2セッション目の接続を確立しようとした場合や、接続から60秒が経過した場合、サーバーから接続が切断されることがあります。</P>
<P align="right"><A href="#top">目次へ</A></P>
<H4><A name="networkjoin-2">2.プロトコルバージョン等の通知</A></H4>
<P>　サーバーへの接続が完了した後、サーバーからコード211（対応プロトコルバージョン等の要求）が送られてきます。これに対しては、コード131（対応プロトコルバージョン等の返答）にて応答します。</P>
<P>　データは「対応プロトコルバージョン」「ソフトウェア名」「ソフトウェアバージョン」の3つです。プロトコルバージョンは「x.xx（例：0.20）」の形式である必要がありますが、ソフトウェア名・ソフトウェアバージョンの表記は自由です。</P>
<P class="sample">↓ 211 1<BR>
↑ 131 1 0.20:P2PQ_Client:Beta2_Rev1000<BR>
↓ 212 1 0.20:P2PQ_Server:Beta2_Rev1000<BR>
（↓ 292 1 Protocol_version_incompatible）<BR>
（↑ 192 1）</P>
<P>　問題がなければ、サーバーからコード212（対応プロトコルバージョン等の返答）が返ります。データ形式はコード131で送ったものと同じです。</P>
<P>　対応するプロトコルバージョンが古く互換性がない場合は、サーバーからコード292（エラー：バージョンが古い）が返されます。その場合は、その旨をユーザーに伝えてP2Pネットワークへの接続を中止する必要があります。逆に、もしサーバーの対応するプロトコルバージョンが古く互換性がない場合は、コード192（エラー：バージョンが古い）を送信し、別のサーバーとの接続を試みてください。</P><P align="right"><A href="#top">目次へ</A></P>
<H4><A name="networkjoin-3">3.ピアIDの暫定割り当て・ポート開放のチェック</A></H4>
<P>　ピアIDとは、P2Pネットワークにおいてピアを識別するために使われるIDのことです。まず、サーバーから暫定的にピアIDを割り当ててもらう必要があります。コード113（ピアID暫定割り当て要求）を送信します。これに対しては、コード233（ピアID暫定割り当て）が返ります。データはピアIDです。</P>
<P class="sample">↑ 113 1<BR>
↓ 233 1 25</P>
<P>　次に、他ピアからの接続を受け付ける場合は、正しくポートが開放されているかチェックするために、受け付け用のポート（6911〜6915等、制限なし）でListenしてから、コード114（ポート開放チェック要求）を送信します。データはピアID、ポート番号です。</P>
<P class="sample">↑ 114 1 25:6911<BR>
↓ 234 1 1</P>
<P>　チェック結果は、コード234（ポート開放チェック返答）で返されます。データが1であれば成功、それ以外（0）であれば失敗です。</P>
<P align="right"><A href="#top">目次へ</A></P>
<H4><A name="networkjoin-4">4.ピアデータの取得・ピアとの接続</A> (Ver0.30 一部追加・変更)</H4>
<P>　次に、ピアとの接続を行うために、ピアデータを取得します。コード115（ピアデータの取得）を送信します。データはピアIDです。サーバーからは、コード235（ピアデータ）が返ります。</P>
<P class="sample">↑ 115 1 25<BR>
↓ 235 1 192.168.0.1,6911,<FONT color="Navy">15</FONT>:192.168.0.2,6915,<FONT color="Navy">81</FONT>:192.168.0.3,6913,<FONT color="Navy">66</FONT><BR>
↑ 155 1 15:66</P>
<P>　データは、ピアごとに「コロン区切り」です。さらに、ピアごとのIPアドレス・ポート番号・<FONT color="Navy">ピアID<B>(Ver0.30新規)</B></FONT>が「カンマ区切り」となっています。これを元に、ピアに接続を試みます。</P>
<P>　3〜5ピアと接続したか、ピアデータを使い果たしたら、<FONT color="Navy"><B>(Ver0.30新規)</B></FONT>コード155（接続ピアID通知）を送信します。データは、接続したピアのIDです。</P>
<P align="right"><A href="#top">目次へ</A></P>
<H4><A name="networkjoin-5">5.ピアIDの本割り当て・鍵の取得</A> (Ver0.29 一部変更)</H4>
<P>　ピアとの接続が完了した場合、暫定的に割り当てられていたピアIDの本割り当てを要求します。コード116（ピアIDの本割り当て要求）を送信します。データは、ピアID、ポート番号、地域コード、接続数、受け入れ可能な最大接続数です。</P>
<P class="sample">↑ 116 1 25:6911:901:2:6:5,8,3<BR>
↓ 236 1 29</P>
<P>　本割り当てが完了した場合、サーバーからコード236（ピアIDの本割り当て）が返ります。データは、現在の参加ピア総数です。</P>
<P>　この後、自らがP2Pネットワークへデータを発信する際に必要なRSA鍵を取得します（地震感知情報メッセージを発信しない場合、取得する必要はありません）。コード117（鍵割り当ての要求）を送信します。データはピアIDです。鍵の割り当てが成功した場合、コード237（鍵割り当て）が返ります。データは、秘密鍵、公開鍵、有効期限、鍵の署名です。秘密鍵・公開鍵・鍵署名はBASE64エンコードされています。有効期限は「YYYY/MM/DD
HH-MM-SS」フォーマットです。</P>
<P class="sample">↑ 117 1 25<BR>
↓ 237 1 ABCDEFGHIJKLMNOPQRSTU:ABCDEFGHIJKLMN:2005/03/14
12-34-56:ABCDEFGHIJKLMN<BR>
（↓ 295 1 Key_has_allocated）</P>
<P>　同一IPアドレスから一定時間内に複数の鍵を取得しようとした場合などでは、コード295（エラー：鍵割り当て済み）が返ります。この場合、P2Pネットワーク参加中の「サーバーへのエコー」時に鍵の再割り当てを試み、割り当てが行われるまでは、「鍵がない（未署名）」状態で地震感知情報メッセージを送信することになります。</P>
<P align="right"><A href="#top">目次へ</A></P>
<H4><A name="networkjoin-6">6.各地域ピア数の取得</A> (Ver0.21新規)</H4>
<P>　各地域のピア数を取得します。コードは127です。サーバーからは、コード247が返ります。</P>
<P class="sample">↑127 1<BR>
↓247 1 001,0;002,2;003,5;004,3</P>
<P>　地域ピア数は、地域ごとに「セミコロン区切り」です。さらに、地域コードとその地域のピア数が「カンマ区切り」となっています。なお、地域ピア数が0である地域のデータは含まれません。</P>
<P align="right"><A href="#top">目次へ</A></P>
<H4><A name="networkjoin-7">7.プロトコル時刻の取得</A></H4>
<P>　鍵やデータの有効期限をチェックする際に必要な「プロトコル時刻」を取得します。コードは118です。サーバーからは、コード238が返ります。</P>
<P class="sample">↑ 118 1<BR>
↓ 238 1 2005/03/19 12-34-56</P>
<P>　時刻フォーマットは「YYYY/MM/DD HH-MM-SS」です。原則として、日本標準時とほぼ同じです。</P>
<P align="right"><A href="#top">目次へ</A></P>
<H4><A name="networkjoin-8">8.サーバーとの接続終了</A></H4>
<P>　ここまでの処理が正常に行われた場合、P2Pネットワークへの参加処理は完了しました。コード119（通信終了要求）を送信し、サーバーからコード239（通信終了）が返れば、サーバーとの接続を切断してください。</P>
<P class="sample">↑ 119 1<BR>
↓ 239 1</P>
<P align="right"><A href="#top">目次へ</A></P>
<H3><A name="echokey">サーバーへの定期エコー</A></H3>
<P>　ピアは、正常に動作していることを通知するため、サーバーに「エコー」する必要があります。エコーは、10分間隔で行ってください。30分以上行われないと、サーバーは「ピアがダウンした」と判断します。</P>
<P align="right"><A href="#top">目次へ</A></P>
<H4><A name="echokey-1">1.サーバーへの接続</A></H4>
<P>　「<A href="#networkjoin">P2Pネットワークへの参加</A> - <A href="#networkjoin-1">1.サーバーへの接続</A>」と同様</P>
<P align="right"><A href="#top">目次へ</A></P>
<H4><A name="echokey-2">2.プロトコルバージョン等の通知</A></H4>
<P>　「<A href="#networkjoin">P2Pネットワークへの参加</A> - <A href="#networkjoin-2">2.プロトコルバージョン等の通知</A>」と同様</P>
<P align="right"><A href="#top">目次へ</A></P>
<H4><A name="echokey-3">3.エコー</A> (Ver0.26 一部変更)</H4>
<P>　エコーは、コード123です。データには、ピアIDと現在のピアとの接続数をを指定します。成功すると、コード243（エコーOK）が返ります。</P>
<P class="sample">↑ 123 1 25:3<BR>
↓ 243 1<BR>
（↓ 299 1 IP_Address_has_been_changed）</P>
<P>　エコー時のIPアドレスが参加時と変わっている場合、コード299が返されることがあります。この場合、一旦ネットワークから切断し、参加しなおしてください。</P>
<P align="right"><A href="#top">目次へ</A></P>
<H4><A name="echokey-4">4.鍵の再割り当て要求</A></H4>
<P>　鍵の有効期限が切れる30分前から、必要に応じてコード124（鍵の再割り当て要求）を行うことが出来ます。データには、ピアID、以前割り当てられた秘密鍵（のBASE64エンコード）を指定します。もし、参加時にコード295が返された等で以前割り当てられた秘密鍵がない場合、「Unknown」を指定します。</P>
<P class="sample">↑ 124 1 25:ABCDEFG<BR>
↓ 244 1 ABCDEFGHIJKLMNOPQRSTU:ABCDEFGHIJKLMN:2005/03/14
12-34-56:ABCDEFGHIJKLMN<BR>
（↓ 295 1 Key_has_allocated）</P>
<P>　鍵の再割り当てが成功すると、コード244が返ります。データは、秘密鍵、公開鍵、有効期限、鍵の署名です。詳細なフォーマットは「<A href="#networkjoin">P2Pネットワークへの参加</A> - <A href="#networkjoin-5">5.ピアIDの本割り当て・鍵の取得</A>」と同様です。同一IPアドレスから一定時間内に複数の鍵を取得しようとした場合などでは、コード295が返ります。この場合、次回エコー時に再び割り当てを試みてください。</P>
<P align="right"><A href="#top">目次へ</A></P>
<H4><A name="echokey-5">5.ピアとの接続数増加</A> (Ver0.30 変更)</H4>
<P>　<FONT color="Navy"><B>Ver0.30で、コードが統合されました。</B></FONT>「<A href="#networkjoin">P2Pネットワークへの参加</A> - <A href="#networkjoin-4">4.ピアデータの取得・ピアとの接続</A>」と同様</P>
<P>　ただし、既に接続済みのピアと複数のセッションを確立することのないよう、ID・IPアドレスが重複していないかチェックする必要があります。</P>
<P>　また、コード155による接続ピアID通知には、新たに接続したピアのIDのみを通知します。</P>
<P align="right"><A href="#top">目次へ</A></P>
<H4><A name="echokey-6">6.プロトコル時刻の再取得</A> (Ver0.28新規)</H4>
<P>　「<A href="#networkjoin">P2Pネットワークへの参加</A> - <A href="#networkjoin-7">7.プロトコル時刻の取得</A>」と同様</P>
<P align="right"><A href="#top">目次へ</A></P>
<H4><A name="echokey-7">7.サーバーとの接続終了</A></H4>
<P>　「<A href="#networkjoin">P2Pネットワークへの参加</A> - <A href="#networkjoin-8">8.サーバーとの接続終了</A>」と同様に、コード119を送信し、コード239が返れば接続を切断します。</P>
<P align="right"><A href="#top">目次へ</A></P>
<H3><A name="networkquit">P2Pネットワークへの参加終了</A></H3>
<P align="right"><A href="#top">目次へ</A></P>
<H4><A name="networkquit-1">1.ピアとの接続終了</A></H4>
<P>　全てのピアとの接続を切断してください。</P>
<P align="right"><A href="#top">目次へ</A></P>
<H4><A name="networkquit-2">2.サーバーへの接続</A></H4>
<P>　「<A href="#networkjoin">P2Pネットワークへの参加</A> - <A href="#networkjoin-1">1.サーバーへの接続</A>」と同様</P>
<P align="right"><A href="#top">目次へ</A></P>
<H4><A name="networkquit-3">3.プロトコルバージョン等の通知</A></H4>
<P>　「<A href="#networkjoin">P2Pネットワークへの参加</A> - <A href="#networkjoin-2">2.プロトコルバージョン等の通知</A>」と同様</P>
<P align="right"><A href="#top">目次へ</A></P>
<H4><A name="networkquit-4">4.参加終了</A></H4>
<P>　参加終了は、コード128で行います。データは、ピアID、以前割り当てた秘密鍵（のBASE64エンコード）です（鍵が割り当てられていない場合は「Unknown」）。正常に完了すれば、コード248が返ります。</P>
<P class="sample">↑ 128 1 25:ABCDEFG<BR>
↓ 248 1</P>
<P>　鍵が正しくない場合はコード293（要求が正しくない）、IPアドレスが参加時と異なっている場合はコード299（IPアドレスが一致しない）が返ります。この場合、どうすることも出来ないので、そのまま次のステップに進んでください。</P>
<P align="right"><A href="#top">目次へ</A></P>
<H4><A name="networkquit-5">5.サーバーとの接続終了</A></H4>
<P>　「<A href="#networkjoin">P2Pネットワークへの参加</A> - <A href="#networkjoin-8">8.サーバーとの接続終了</A>」と同様に、コード119を送信し、コード239が返れば接続を切断します。</P>
<P align="right"><A href="#top">目次へ</A></P>
<H3><A name="peersys">ピアとのシステム通信</A></H3>
<P align="right"><A href="#top">目次へ</A></P>
<H4><A name="peersys-1">1.接続の受け付け</A></H4>
<P>　ポートを開放している場合、他ピアからの接続を受け付けることがあります。接続数が限界ではない限り、速やかに接続を受け入れてください。</P>
<P>　受け入れた後、接続先のIPアドレスを調べた上で、他に接続しているピアとIPアドレスが重複していないか確認してください。重複していた場合、受け入れた接続を切断してください。これは、同一ピアと2セッション接続してしまうことを防ぐためです。</P>
<P align="right"><A href="#top">目次へ</A></P>
<H4><A name="peersys-2">2.接続時の初期通信</A> (Ver0.30 名称変更、一部追加)</H4>
<P>　他ピアからの接続を受け付けた場合、プロトコルバージョンとピアIDをやり取りします。</P>
<P>　まず、コード614(バージョン要求)でプロトコルバージョンを要求します。コード634(バージョン返答)が返ります。</P>
<P class="sample">↑ 614 1 0.30:P2PQ_Client:Beta2.1_Rev1000<BR>
↓ 634 1 0.30:P2PQ_Client:Beta2.1_Rev1002<BR>
（↓ 694 1 Protocol_version_incompatible）</P>
<P>　相手プロトコルバージョンが古い場合、コード694を返し、接続を切断します。</P>
<P>　次に、ピアIDを把握するために、コード612（ピアID要求）でピアIDを要求します。ピアからは、コード632（ピアID返答）が返ります。データはピアIDです。</P>
<P class="sample">↑ 612 1<BR>
↓ 632 1 26</P>
<P>　コード632が返りピアIDが判明した場合、接続中のピアとピアIDが重複していないか確認してください。重複していた場合、新たに接続してきたピアとの接続を切断します。これは、同一ピアと2セッション接続してしまうことを防ぐためです。</P>
<P>　注意：2セッション接続しているかどうかの判定がIPアドレス・ピアIDと二重ですが、問題はありません。</P>
<P align="right"><A href="#top">目次へ</A></P>
<H4><A name="peersys-3">3.ピア同士のエコー</A></H4>
<P>　ピアとの接続が切断していないかチェックするために、2〜5分程度の間隔で接続中のピアにコード611（ピアエコー要求）を送信します。接続が正常であれば、相手からはコード631（ピアエコー返答）が返ります。</P>
<P class="sample">↑ 611 1<BR>
↓ 631 1</P>
<P>　10〜30秒以内に相手から応答が返らない場合や、ソケット状態が「エラー」となっている場合は、ピアとの接続を切断してください。</P>
<P align="right"><A href="#top">目次へ</A></P>
<H4><A name="peersys-4">4.ピアネットワークの調査</A> (Ver0.28 新規)</H4>
<P>　ピアとピアとの繋がりを視覚化します。いわばEPSP上のtracerouteですが、仕組みは若干異なります。</P>
<OL>
  <LI>調査したいピアは、「調査エコー(コード615)」を発信します。データには、発信元ピアIDと、調査エコーを識別するための一意な数を指定します。
  <P class="sample">↑ 615 1 35:35196742</P>
  <LI>「調査エコー(コード615)」を受信したピアは、過去の調査エコーバッファと比較し、新規エコーだった場合のみ処理を続けます。
  <OL>
    <LI type="a" value="1">「一意な数」と「送信元（ソケット番号など、後で送り返しするために必要な値）」を新たにバッファに追加します。
    <LI>調査エコーを、接続している他のピアにもリレーします。
    <LI>送信元に対し、「調査エコーリプライ(コード635)」を送信します。データには、調査エコーで指定されていた発信元ピアID・一意な数と、自らのピアID・接続中のピアID(コロン区切り)・調査エコーが届いた経由数を指定します。
    <P class="sample">↓ 615 7 35:35196742<BR>
    ↑ 635 1 35:35196742:38:12,67:7</P>
  </OL>
  <LI type="1">「調査エコーリプライ(コード635)」を受信したピアは、受信したデータの「一意な数」と、過去の調査エコーバッファの「一意な数」と比較します。一致するバッファがあった場合のみ処理を続けます。
  <OL>
    <LI type="a">過去の調査エコーバッファで記憶されている「送信元」に対し、調査エコーリプライをリレーします。<BR>送信元との接続が切断されている場合は、接続中の全てのピアに対してリレーします。
  </OL>
  <LI>調査したいピアに対して、調査エコーリプライが続々と届きます。各ピアがどのように繋がりを持っているかを知ることが出来ます。</OL>
<P>　なお、このネットワーク調査については、<U>完全な対応を必須としません</U>。ただし、受信した「調査エコー」または「調査エコーリプライ」を接続中の全てのピアにリレーすることは必須です。</P>
<P align="right"><A href="#top">目次へ</A></P>
<H3><A name="peerdata">ピアとのデータ通信</A></H3>
<P align="right"><A href="#top">目次へ</A></P>
<H4><A name="peerdata-1">1.重複判定・各ピアへの伝達</A></H4>
<P>　当プロトコルでは、複数のピアと接続していることから、複数のピアから同一の通信データを受信することが当たり前のようにあります。そのため、同一の通信データかどうかを判断し、同一「ではない」場合にのみ処理を行う必要があります。</P>
<P>　同一の通信データかどうかを判断するには、「データ署名」を用いてください（データ署名をバッファに保持しておき、重複するデータ署名がないか確認する等）。</P>
<P>　そして、同一「ではない」と判断された場合、署名やその他を検証する前に、速やかにデータを送ってきたピア「以外」の他ピアへ情報を伝達する必要があります（※その際、「<A href="#base-2">基本概要 - 2.基本仕様</A>」に記されているよう、経由数を1プラスする必要があります）。</P>
<P align="right"><A href="#top">目次へ</A></P>
<H4><A name="peerdata-2">2.署名</A> (Ver0.27r 表記変更)</H4>
<P>　サーバーからのデータには、それがサーバーから発信されたことを示す署名が含まれています。次の方法で署名の検証を行うことが出来ます。</P>
<OL>
  <LI>
  <DL>
    <DT>「データ署名」の検証
    <DD>「サーバー保証用公開鍵」を使用し、「データ署名」が、「有効期限(YYYY/MM/DD
    HH-NN-SS)」と「データのMD5ハッシュ(バイナリ)」を結合したデータの署名であるかを検証します。<BR>MD5ハッシュとなるデータは、地震情報では「地震情報概要」と「地震情報詳細」、津波予報では「津波予報詳細」、各地域ピア数では「地域ピア数（全体）」です。</DL>
  <LI>
  <DL>
    <DT>「有効期限」の確認
    <DD>「有効期限」が切れていないかを確認します。</DL>
</OL>
<P align="right"><A href="#top">目次へ</A></P>
<H4><A name="peerdata-3">3.地震情報</A> (Ver0.23,0.25,0.27 一部変更)</H4>
<P>　地震情報はサーバーから発信されます。が、サーバーも「1ピア」として発信するため、実装で特に意識する必要はありません。地震情報は、コード551です。データは、コロン区切りで「データ署名」「有効期限」「地震情報概要」「地震情報詳細」と大きく4つに分かれています。クライアントで表示フォーマットを自由にデザインすることが出来ます。</P>
<P class="sample">↓ 551 5 ABCDEFG:2005/03/27 12-34-56:12時34分頃,3,1,4,紀伊半島沖,ごく浅く,3.2,1,N12.3,E45.6,仙台管区気象台:-奈良県,+2,*下北山村,+1,*十津川村,*奈良川上村</P>
<P>　地震情報概要は、カンマ区切りで「発生時刻」「震度」「津波の有無（0=なし,1=あり,2=調査中,3=不明）」「地震情報種類（1=震度速報,2=震源情報,3=震源・震度情報,4=震源・詳細震度情報,5=遠地地震情報）」「震源」「深さ」「マグニチュード」「震度訂正(0=いいえ,1=はい)」「緯度(N=北緯,S=南緯)」「経度(E=東経,W=西経)」「発表管区」となっています。</P>
<P>　地震情報詳細は、カンマ区切りです。先頭に「-」があれば都道府県名、「+」があれば震度、「*」があれば震度観測点名です。</P>
<P>　注意：地震情報の種類により、震源または地震情報詳細が空である場合があります。震度は「5弱」等文字列が含まれることがあります。地震情報詳細の震度にはさらに「5弱以上（推定）」も含まれることがあります。</P>
<P class="sample"><B>[表示例]</B><BR>
12時34分頃、震度3の地震がありました。津波の心配はありません。震源は紀伊半島沖、深さはごく浅く、マグニチュードは3.2と推定されます。震度が訂正されました。<BR>
【奈良県】震度2：下北山村　震度1：十津川村
奈良川上村</P>
<P align="right"><A href="#top">目次へ</A></P>
<H4><A name="peerdata-4">4.津波予報</A></H4>
<P>　地震情報と同じように、津波予報もサーバーから発信されます。サーバーが「1ピア」として発信する点も同じです。津波予報は、コード552です。データは、コロン区切りで「データ署名」「有効期限」「津波予報詳細」と大きく3つに分かれています。</P>
<P class="sample">↓ 552 6 ABCDEFG:2005/03/27 12-34-56:-大津波警報,*和歌山県,-津波警報,+淡路島南部,+徳島県,-津波注意報,+大阪府,+兵庫県瀬戸内海沿岸</P>
<P>　津波予報詳細は、カンマ区切りです。先頭に「-」があれば予報種類（津波注意報・津波警報・大津波警報）、「+」または「*」があれば予報区名です。「*」は、その予報区に直ちに津波が来襲することを示します。ただし、解除された場合は、単に「解除」という文字列が入ります。</P>
<P>　予報区は、気象庁の「<A href="http://www.seisvol.kishou.go.jp/eq/" target="_blank">地震・津波の資料</A>」の「<A href="http://www.seisvol.kishou.go.jp/eq/index_t-yohokuinfo.html" target="_blank">津波予報区について</A>」に記載されています。</P>
<P>　なお、仮に津波予報が各管区気象台から別々に発表された場合、（Webサイトへの更新のタイミングから）その<FONT color="#ff0000"><U>一部を取りこぼす可能性がある重大な問題を含んでいます</U></FONT>。当プロトコルに準拠するソフトウェアを公開される場合は、ヘルプ等に必ずこれを明記してください。</P>
<P align="right"><A href="#top">目次へ</A></P>
<H4><A name="peerdata-5">5.各地域ピア数</A></H4>
<P>　「各地域ピア数」とは、ピアが通知した「地域コード」を元に、各地域のピア数を示したものです。各地域ピア数もサーバーが「1ピア」として発信します。各地域ピア数はコード561です。データは、コロン区切りで「データ署名」「有効期限」「地域ピア数」です。</P>
<P class="sample">↓561 25 ABCDEFG:2005/03/27 12-34-56:001,0;002,2;003,5;004,3</P>
<P>　地域ピア数は、地域ごとに「セミコロン区切り」で分かれています。さらに、地域コードとその地域のピア数が「カンマ区切り」となっています。なお、地域ピア数が0である地域のデータは含まれません。</P>
<P align="right"><A href="#top">目次へ</A></P>
<H4><A name="peerdata-6">6.ユーザー署名の扱い - 署名</A> (Ver0.27r,0.30 一部変更)</H4>
<P>　地震感知情報データは、ユーザーから発信されます。「正しい方法によって発信された」ことを示すために、発信時にデータの署名を行う必要があります。</P>
<OL>
  <LI>
  <DL>
    <DT>有効期限のセット
    <DD>プロトコル時刻から、プラス1分にセットします（<I>Ver0.30r2以前は3分、Ver0.27r以前は3〜4分程度</I>）。</DL>
  <LI>
  <DL>
    <DT>署名の実施
    <DD>サーバーから割り当てられた「秘密鍵」を使用し、署名を行います。署名結果は「データ署名」と呼びます。<BR>
    署名の元となるデータは、「有効期限」と「データのMD5ハッシュ(バイナリ)」を結合したものです。<BR>
    MD5ハッシュの元となるデータは、<FONT color="Navy"><B>(Ver0.30 変更)</B></FONT>「地震感知情報データ」です（カンマ区切りそのまま）。
  </DL>
  <LI>
  <DL>
    <DT>BASE64エンコード
    <DD>生成された「データ署名」、サーバーから割り当てられた「公開鍵」、同様に割り当てられた「鍵署名」を、それぞれBASE64エンコードします。<BR>BASE64エンコード結果に改行を含む場合は、改行を取り除きます。
  </DL>
</OL>
<P>　このようにして出来た「データ署名」「公開鍵」「鍵署名」のBASE64エンコードデータは、「9.地震感知情報」発信に使用されます。</P>
<P align="right"><A href="#top">目次へ</A></P>
<H4><A name="peerdata-7">7.ユーザー署名の扱い - 検証</A> (Ver0.27r,0.30 一部変更)</H4>
<P>　逆に、地震感知情報データが「正しい方法によって発信された」ことを確かめるには、次のようにして検証します。</P>
<OL>
  <LI>
  <DL>
    <DT>BASE64デコード
    <DD>受信した「データ署名」「公開鍵」「鍵署名」をそれぞれBASE64デコードします。</DL>
  <LI>
  <DL>
    <DT>鍵署名の検証
    <DD>「ピア保証用公開鍵」を使用し、「鍵署名」が、「公開鍵(バイナリ)」と「（あわせて受信した）鍵期限(YYYY/MM/DD
    HH-NN-SS)」を結合したデータの署名であるかを確認します。<BR>加えて、「鍵期限」が切れていないか確認します。</DL>
  <LI>
  <DL>
    <DT>データ署名の検証
    <DD>受信・デコードした「公開鍵」を使用し、「データ署名」が「有効期限(YYYY/MM/DD
    HH-NN-SS)」と「データのMD5ハッシュ(バイナリ)」を結合したデータの署名であるかを確認します。<BR>
    MD5ハッシュの元となるデータは、<FONT color="Navy"><B>(Ver0.30 変更)</B></FONT>「地震感知情報データ」です（カンマ区切りそのまま）。<BR>
    <BR>
    <B><FONT color="Navy">(Ver0.30 廃止というか不要に)</FONT></B><S><FONT color="Gray">※Ver0.27r発行時点のオフィシャルP2PQ_Clientでは、誤った実装により「有効期限」と「データ」を結合したもので署名が行われています。</FONT></S>
  </DL>
  <LI>「有効期限」の確認
</OL>
<P>　これにより、「サーバーから割り当てられた鍵を用いて発信された」ことを確認することが出来ます。</P>
<P align="right"><A href="#top">目次へ</A></P>
<H4><A name="peerdata-8">8.「多重発信」の識別</A></H4>
<P>　悪意のあるなしに関わらず、1人によって地震感知情報が大量に発信されれば、地震感知情報は使い物にならなくなってしまいます。このようなことを防ぐために、受信側で何らかの対策が必要となります。</P>
<P>　例えば、地震感知情報では「同じ公開鍵によるものは1分に1回しか受け付けない」ようにします。これにより、何者かが1分に100回の地震感知情報を発信しても、100回のうち99回は「無効」として処理されるため、機能に支障をきたすことがなくなります。実際には、5〜10分に1回しか受け付けないぐらいでも良いでしょう。</P>
<P align="right"><A href="#top">目次へ</A></P>
<H4><A name="peerdata-9">9.地震感知情報</A> (Ver0.30 変更)</H4>
<P>　地震感知情報は、ユーザーによる「揺れた」という情報のことです。コード555で、<B><FONT color="Navy">(Ver0.30変更)</FONT></B>データは「データ署名」「有効期限」「公開鍵」「鍵署名」「鍵期限」「感知情報データ」です。「感知情報データ」には、カンマ区切りで「ユニーク値」「地域コード」が入っています。</P>
<P class="sample">↓ 555 13 ABCDEFG:2005/03/27 12-34-56:ABCEFFG:ABCDEFG:2005/03/14
12-34-56:2503151124,901</P>
<P>　「ユニーク値」には、「ピアIDと日時」といった重複しない文字列を指定します。</P>
<P>　この地震感知情報はユーザーによるものであり、誤報も多く含みます。そのため、受信した時点ですぐに表示はせず、「30秒間に一定件数以上を受信した場合」といった条件で表示することを推奨します。</P>
<P align="right"><A href="#top">目次へ</A></P>
<H4><A name="peerdata-10">10.伝言板</A> (Ver0.30 変更、0.33 廃止)</H4>
<P><FONT color="Gray">　伝言板は、地震発生時・地震感知情報表示時における情報交換に使用するものです。コード556で、<B><FONT color="Navy">(Ver0.30変更)</FONT></B>データは「データ署名」「有効期限」「公開鍵」「鍵署名」「鍵期限」「伝言板データ」です。「伝言板データ」には、カンマ区切りで「名前」「地域コード」「メッセージ」「ID(予約)」「ID署名(予約)」が入っています。</FONT></P>
<P class="sample">↑ 556 1 ABCDEFG:2005/03/27 12-34-56:ABCDEFG:ABCDEFG:2005/03/14
12-34-56:ななし,901,めるぽ！,Reserved,Reserved</P>
<P><FONT color="Gray">　メッセージにコロン(:)・アンパサンド(&amp;)・改行が含まれる場合、送信・受信時にそれぞれ置き換えを行う必要があります。コロンは「&amp;colon;」、アンパサンドは「&amp;amp;」、改行は「&amp;newline;」です。</FONT></P>
<P align="right"><A href="#top">目次へ</A></P>
</BODY>
</HTML>
